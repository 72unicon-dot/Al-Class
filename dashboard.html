<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내 강의실 | AI Class</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .gradient-hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>

<body class="bg-gray-50">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="container mx-auto px-6 h-16 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">AI
                </div>
                <span class="text-xl font-bold text-gray-800">Class Studio</span>
            </a>

            <div class="flex items-center gap-4">
                <span id="userNameDisplay" class="text-sm text-gray-600 font-medium hidden md:block"></span>
                <button onclick="logout()" class="text-sm text-gray-500 hover:text-indigo-600 transition-colors">
                    <i class="fas fa-sign-out-alt"></i> 로그아웃
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-12 min-h-[calc(100vh-200px)]">

        <!-- Welcome Section -->
        <div class="mb-12">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">내 강의실</h1>
            <p class="text-gray-600">수강 중인 강의를 확인하고 학습을 이어서 진행하세요.</p>
        </div>

        <!-- Course Grid -->
        <div id="courseList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Loading State -->
            <div class="col-span-full text-center py-20">
                <i class="fas fa-circle-notch fa-spin text-4xl text-indigo-200 mb-4"></i>
                <p class="text-gray-500">강의 목록을 불러오는 중입니다...</p>
            </div>
        </div>

        <!-- Empty State (Hidden) -->
        <div id="emptyState" class="hidden text-center py-20 bg-white rounded-3xl border border-gray-200 shadow-sm">
            <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-book-open text-3xl text-indigo-400"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">수강 중인 강의가 없습니다</h3>
            <p class="text-gray-500 mb-8 max-w-md mx-auto">아직 신청한 강의가 없으신가요? <br>지금 바로 나에게 맞는 AI 과정을 찾아보세요.</p>
            <a href="index.html#courses"
                class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200">
                과정 둘러보기
            </a>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-100 py-8 text-center text-gray-500 text-sm">
        <p>© 2026 AI Class Studio. All rights reserved.</p>
    </footer>

    <!-- Script -->
    <script type="module">
        import { db, auth } from './js/firebase-config.js';
        import { collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Auth Logic
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // Not logged in -> Redirect to home
                alert("로그인이 필요한 페이지입니다.");
                window.location.href = 'index.html?apply=true';
                return;
            }

            // User Display
            document.getElementById('userNameDisplay').innerText = `${user.displayName || '수강생'}님 환영합니다`; // fallback

            // Load Courses
            loadMyCourses(user.uid);
        });

        async function loadMyCourses(userId) {
            const listContainer = document.getElementById('courseList');
            const emptyState = document.getElementById('emptyState');

            try {
                // Query applications for this user
                const q = query(collection(db, "applications"), where("userId", "==", userId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    listContainer.innerHTML = '';
                    listContainer.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }

                let html = '';

                // ==========================================
                // Link Mapping Definition
                // ==========================================
                const courseMap = {
                    "AI 실무 마스터": "classroom.html",
                    "AI소개 및 윤리": "classroom_ethics.html", "AI 윤리": "classroom_ethics.html",
                    "AI 기초 입문": "classroom_basics.html",
                    "AI 비즈니스 활용": "classroom_business.html",
                    "AI 전문가 심화": "classroom_advanced.html",
                    "AI 마케팅 전문가": "classroom_marketing.html",
                    "AI 제조 전문가": "classroom_manufacturing.html",
                    "AI 데이터 분석가": "classroom_data.html",
                    "AI 영상 크리에이터": "classroom_video.html",
                    "AI시대의 리더십": "classroom_leadership.html",
                    "AI 비즈니스 컨설턴트": "classroom_consultant.html",
                    "비즈니스 앱 크리에이터": "classroom_app_creator.html"
                };

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const statusBadge = data.status === 'approved'
                        ? '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded">수강중</span>'
                        : '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-bold rounded">승인 대기중</span>';

                    // Resolve Link based on Course Name
                    const targetPage = courseMap[data.courseName] || "classroom.html";

                    html += `
                    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden hover:shadow-lg transition-all group">
                        <div class="h-32 bg-gray-100 relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 opacity-90"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <i class="fas fa-chalkboard-teacher text-4xl text-white/20 transform group-hover:scale-110 transition-transform"></i>
                            </div>
                            <div class="absolute top-4 right-4">
                                ${statusBadge}
                            </div>
                        </div>
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-2 truncate">${data.courseName || '강의명 없음'}</h3>
                            <p class="text-gray-500 text-sm mb-6">AI 실무 마스터 클래스 시리즈</p>
                            
                            <div class="border-t border-gray-100 pt-4 flex justify-between items-center">
                                <span class="text-xs text-gray-400">신청일: ${data.appliedAt ? new Date(data.appliedAt.seconds * 1000).toLocaleDateString() : '-'}</span>
                                <a href="${targetPage}" class="text-indigo-600 font-bold text-sm hover:underline">
                                    강의실 입장 <i class="fas fa-arrow-right ml-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    `;
                });

                listContainer.innerHTML = html;
                listContainer.classList.remove('hidden');
                emptyState.classList.add('hidden');

            } catch (error) {
                console.error("Error loading courses:", error);
                listContainer.innerHTML = '<div class="col-span-full text-center text-red-400">강의 목록을 불러오지 못했습니다.</div>';
            }
        }

        window.logout = () => {
            if (confirm("로그아웃 하시겠습니까?")) {
                signOut(auth).then(() => window.location.href = 'index.html');
            }
        }
    </script>
</body>

</html>